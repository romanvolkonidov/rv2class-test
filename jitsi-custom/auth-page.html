<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Product" prefix="og: http://ogp.me/ns#" xmlns="http://www.w3.org/1999/html">
  <head>
    
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="#2A3A4B">
    

    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="stylesheet" href="css/all.css?v=8821">
    <!--#include virtual="fonts.html"-->
    <link rel="manifest" id="manifest-placeholder">

    <script>
        function contextRoot(pathname) {
            const contextRootEndIndex = pathname.lastIndexOf('/');

            return (
                contextRootEndIndex === -1
                ? '/'
                : pathname.substring(0, contextRootEndIndex + 1)
            );
        }
        window.EXCALIDRAW_ASSET_PATH = 'libs/';
        // Dynamically generate the manifest location URL. It must be served from the document origin, and we may have
        // the base pointing to the CDN. This way we can generate a full URL which will bypass the base.
        document.querySelector('#manifest-placeholder').setAttribute('href', window.location.origin + contextRoot(window.location.pathname) + 'manifest.json');

        document.addEventListener('DOMContentLoaded', () => {
            if (!JitsiMeetJS.app) {
                return;
            }

            // Check Firebase auth before loading Jitsi
            checkAuthAndRender();
        });

        // Firebase modules - store globally
        let auth, provider, signInWithPopup, signOut;

        // Firebase auth check
        async function checkAuthAndRender() {
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            
            // Store in global scope
            signInWithPopup = firebaseAuth.signInWithPopup;
            signOut = firebaseAuth.signOut;
            
            const firebaseConfig = {
                apiKey: "AIzaSyB_VsLZaaQ_m3WNVlPjfhy715BXo8ax004",
                authDomain: "tracking-budget-app.firebaseapp.com",
                databaseURL: "https://tracking-budget-app-default-rtdb.firebaseio.com",
                projectId: "tracking-budget-app",
                storageBucket: "tracking-budget-app.appspot.com",
                messagingSenderId: "912992088190",
                appId: "1:912992088190:web:926c8826b3bc39e2eb282f"
            };

            const app = initializeApp(firebaseConfig);
            auth = firebaseAuth.getAuth(app);
            provider = new firebaseAuth.GoogleAuthProvider();

            firebaseAuth.onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, check if they want to start lesson
                    const wantsToStartLesson = sessionStorage.getItem('start_lesson');
                    if (wantsToStartLesson) {
                        // Redirect to teacher's permanent room prejoin
                        const teacherRoom = 'teacher-' + user.uid.substring(0, 8);
                        
                        // Store teacher's first name for room display
                        const firstName = user.displayName ? user.displayName.split(' ')[0] : 'Teacher';
                        localStorage.setItem('teacherFirstName', firstName);
                        localStorage.setItem('teacherRoomId', teacherRoom);
                        
                        sessionStorage.removeItem('start_lesson');
                        window.location.href = '/' + teacherRoom;
                    } else {
                        // Show teacher home page
                        showTeacherHome(user);
                    }
                } else {
                    // Not signed in, show auth page
                    showAuthPage();
                }
            });
        }

        function showAuthPage() {
            document.getElementById('react').innerHTML = `
                <div class="premeeting-screen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #1E1E1E;">
                    <div class="content" style="background: #292929; padding: 40px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center;">
                        <h1 style="color: #E7E7E7; font-size: 32px; margin-bottom: 8px;">RV2Class</h1>
                        <h2 style="color: #E7E7E7; font-size: 24px; margin-bottom: 8px;">Welcome!</h2>
                        <p style="color: #A4B5B8; font-size: 14px; margin-bottom: 32px;">Sign in to join your virtual classroom</p>
                        <button id="googleSignIn" style="width: 100%; padding: 16px; background: #3D7CC9; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: 600;">
                            Continue with Google
                        </button>
                        <div id="authError" style="color: #E15350; margin-top: 16px; display: none;"></div>
                    </div>
                </div>
            `;

            document.getElementById('googleSignIn').addEventListener('click', async () => {
                try {
                    document.getElementById('googleSignIn').textContent = 'Signing in...';
                    document.getElementById('googleSignIn').disabled = true;
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Sign in error:', error);
                    document.getElementById('authError').textContent = 'Failed to sign in. Please try again.';
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('googleSignIn').textContent = 'Continue with Google';
                    document.getElementById('googleSignIn').disabled = false;
                }
            });
        }

        function showTeacherHome(user) {
            document.getElementById('react').innerHTML = `
                <div class="premeeting-screen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #1E1E1E;">
                    <div class="content" style="background: #292929; padding: 40px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <!-- Header with user info -->
                        <div style="display: flex; align-items: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #3A3A3A;">
                            <img src="${user.photoURL}" alt="Avatar" style="width: 56px; height: 56px; border-radius: 50%; border: 2px solid #3D7CC9; margin-right: 16px;">
                            <div style="flex: 1;">
                                <div style="color: #E7E7E7; font-size: 20px; font-weight: 600; margin-bottom: 4px;">${user.displayName}</div>
                                <div style="color: #A4B5B8; font-size: 14px;">Teacher</div>
                            </div>
                            <button id="logoutBtn" style="padding: 8px 16px; background: transparent; color: #A4B5B8; border: 1px solid #525A5E; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                Sign out
                            </button>
                        </div>

                        <!-- Main actions -->
                        <h2 style="color: #E7E7E7; font-size: 24px; margin-bottom: 24px; text-align: center;">What would you like to do?</h2>
                        
                        <button id="startLessonBtn" style="width: 100%; padding: 20px; background: #3D7CC9; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
                                <path d="M8 5v14l11-7z" fill="currentColor"/>
                            </svg>
                            Start a Lesson
                        </button>
                        
                        <button id="studentsBtn" style="width: 100%; padding: 20px; background: #1E1E1E; color: #E7E7E7; border: 1px solid #525A5E; border-radius: 6px; font-size: 18px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" fill="currentColor"/>
                            </svg>
                            Students
                        </button>

                        <div style="margin-top: 24px; padding: 16px; background: #1E1E1E; border-radius: 6px; border-left: 3px solid #3D7CC9;">
                            <div style="color: #A4B5B8; font-size: 13px; line-height: 1.5;">
                                <strong style="color: #E7E7E7;">Your classroom:</strong><br>
                                teacher-${user.uid.substring(0, 8)}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add hover effects
            const style = document.createElement('style');
            style.textContent = `
                #startLessonBtn:hover {
                    background: #4A8BD6 !important;
                }
                #studentsBtn:hover {
                    background: #2A2A2A !important;
                }
            `;
            document.head.appendChild(style);

            document.getElementById('startLessonBtn').addEventListener('click', () => {
                sessionStorage.setItem('start_lesson', 'true');
                location.reload();
            });

            document.getElementById('studentsBtn').addEventListener('click', () => {
                window.location.href = '/students';
            });

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await signOut(auth);
                sessionStorage.removeItem('start_lesson');
            });
        }
        
        function showWelcomePage(user) {
            document.getElementById('react').innerHTML = `
                <div class="premeeting-screen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #1E1E1E;">
                    <div class="content" style="background: #292929; padding: 40px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center;">
                        <h2 style="color: #E7E7E7; font-size: 24px; margin-bottom: 32px;">Ready to join?</h2>
                        <div style="background: #1E1E1E; padding: 24px; border-radius: 8px; margin-bottom: 24px;">
                            <img src="${user.photoURL}" alt="Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #3D7CC9; margin-bottom: 16px;">
                            <div style="color: #E7E7E7; font-size: 20px; font-weight: 600; margin-bottom: 4px;">${user.displayName}</div>
                            <div style="color: #A4B5B8; font-size: 14px;">${user.email}</div>
                        </div>
                        <button id="startBtn" style="width: 100%; padding: 16px; background: #3D7CC9; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: 600; margin-bottom: 12px;">
                            Start
                        </button>
                        <button id="logoutBtn" style="width: 100%; padding: 12px; background: transparent; color: #A4B5B8; border: 1px solid #525A5E; border-radius: 4px; font-size: 14px; cursor: pointer;">
                            Sign out
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('startBtn').addEventListener('click', () => {
                sessionStorage.setItem('jitsi_started', 'true');
                location.reload();
            });

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await signOut(auth);
                sessionStorage.removeItem('jitsi_started');
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const isEmbedded = () => {
                try {
                    return window.self !== window.top;
                } catch (e) {
                    return true;
                }
            };

            const isElectron = navigator.userAgent.includes('Electron');
            const shouldRegisterWorker = !isElectron && !isEmbedded() && 'serviceWorker' in navigator;

            if (shouldRegisterWorker) {
                navigator.serviceWorker
                    .register(window.location.origin + contextRoot(window.location.pathname) + 'pwa-worker.js')
                    .then(reg => {
                        console.log('Service worker registered.', reg);
                    })
                    .catch(err => {
                        console.log(err);
                    });
            }
        });
    </script>
    <script>
        // IE11 and earlier can be identified via their user agent and be
        // redirected to a page that is known to have no newer js syntax.
        if (window.navigator.userAgent.match(/(MSIE|Trident)/)) {
            var roomName = encodeURIComponent(window.location.pathname);
            window.location.pathname = 'static/recommendedBrowsers.html';
        }

        window.indexLoadedTime = window.performance.now();
        console.log("(TIME) index.html loaded:\t", indexLoadedTime);
        window.addEventListener('load', function() {
            window.loadedEventTime = window.performance.now();
            console.log("(TIME) window loaded event:\t", loadedEventTime);
        });

        // XXX the code below listeners for errors and displays an error message
        // in the document body when any of the required files fails to load.
        // The intention is to prevent from displaying broken page.
        var criticalFiles = [
            "config.js",
            "utils.js",
            "do_external_connect.js",
            "interface_config.js",
            "lib-jitsi-meet.min.js",
            "app.bundle.min.js",
            "all.css?v=8821"
        ];
        var loadErrHandler = function(e) {
            var target = e.target;
            // Error on <script> and <link>(CSS)
            // <script> will have .src and <link> .href
            var fileRef = (target.src ? target.src : target.href);
            if (("SCRIPT" === target.tagName || "LINK" === target.tagName)
                && criticalFiles.some(
                    function(file) { return fileRef.indexOf(file) !== -1 })) {
                window.onload = function() {
                    // The whole complex part below implements page reloads with
                    // "exponential backoff". The retry attempt is passes as
                    // "rCounter" query parameter
                    var href = window.location.href;

                    var retryMatch = href.match(/.+(\?|&)rCounter=(\d+)/);
                    var retryCountStr = retryMatch ? retryMatch[2] : "0";
                    var retryCount = Number.parseInt(retryCountStr);

                    if (retryMatch == null) {
                        var separator = href.indexOf("?") === -1 ? "?" : "&";
                        var hashIdx = href.indexOf("#");

                        if (hashIdx === -1) {
                            href += separator + "rCounter=1";
                        } else {
                            var hashPart = href.substr(hashIdx);

                            href = href.substr(0, hashIdx)
                                + separator + "rCounter=1" + hashPart;
                        }
                    } else {
                        var separator = retryMatch[1];

                        href = href.replace(
                            /(\?|&)rCounter=(\d+)/,
                            separator + "rCounter=" + (retryCount + 1));
                    }

                    var delay = Math.pow(2, retryCount) * 2000;
                    if (isNaN(delay) || delay < 2000 || delay > 60000)
                        delay = 10000;

                    var showMoreText = "show more";
                    var showLessText = "show less";

                    document.body.innerHTML
                        = "<div style='"
                        + "position: absolute;top: 50%;left: 50%;"
                        + "text-align: center;"
                        + "font-size: medium;"
                        + "font-weight: 400;"
                        + "transform: translate(-50%, -50%)'>"
                        + "Uh oh! We couldn't fully download everything we needed :("
                        + "<br/> "
                        + "We will try again shortly. In the mean time, check for problems with your Internet connection!"
                        + "<br/><br/> "
                        + "<div id='moreInfo' style='"
                        + "display: none;'>" + "Missing " + fileRef
                        + "<br/><br/></div>"
                        + "<a id='showMore' style='"
                        + "text-decoration: underline;"
                        + "font-size:small;"
                        + "cursor: pointer'>" + showMoreText + "</a>"
                        + "&nbsp;&nbsp;&nbsp;"
                        + "<a id ='reloadLink' style='"
                        + "text-decoration: underline;"
                        + "font-size:small;"
                        + "'>reload now</a>"
                        + "</div>";

                    var reloadLink = document.getElementById('reloadLink');
                    reloadLink.setAttribute('href', href);

                    var showMoreElem = document.getElementById("showMore");
                    showMoreElem.addEventListener('click', function () {
                            var moreInfoElem
                                    = document.getElementById("moreInfo");

                            if (showMoreElem.innerHTML === showMoreText) {
                                moreInfoElem.setAttribute(
                                    "style",
                                    "display: block;"
                                    + "color:#FF991F;"
                                    + "font-size:small;"
                                    + "user-select:text;");
                                showMoreElem.innerHTML = showLessText;
                            }
                            else {
                                moreInfoElem.setAttribute(
                                    "style", "display: none;");
                                showMoreElem.innerHTML = showMoreText;
                            }
                        });

                    window.setTimeout(
                        function () { window.location.replace(href); }, delay);

                    // Call extra handler if defined.
                    if (typeof postLoadErrorHandler === "function") {
                        postLoadErrorHandler(fileRef);
                    }
                };
                window.removeEventListener(
                    'error', loadErrHandler, true /* capture phase */);
            }
        };
        window.addEventListener(
            'error', loadErrHandler, true /* capture phase type of listener */);
    </script>
    <script><!--#include virtual="/config.js" --></script><!-- adapt to your needs, i.e. set hosts and bosh path -->
    <script><!--#include virtual="/interface_config.js" --></script>
    <script src="libs/lib-jitsi-meet.min.js?v=8821"></script>
    <script src="/config.js"></script>
    <script src="/interface_config.js"></script>
    <script src="libs/app.bundle.min.js?v=8821"></script>
    
    <!--#include virtual="plugin.head.html" -->
    <!--#include virtual="static/welcomePageAdditionalContent.html" -->
    <!--#include virtual="static/welcomePageAdditionalCard.html" -->
    <!--#include virtual="static/settingsToolbarAdditionalContent.html" -->
  </head>
  <body>
    <noscript aria-hidden="true">
        <div>JavaScript is disabled. </br>For this site to work you have to enable JavaScript.</div>
    </noscript>
    
    <div id="react" role="main"></div>
  </body>
</html>
