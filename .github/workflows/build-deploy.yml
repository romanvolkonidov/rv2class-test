name: Build and Deploy RV2Class

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd jitsi-custom/jitsi-meet
        npm ci --legacy-peer-deps
        
    - name: Build production bundle
      run: |
        cd jitsi-custom/jitsi-meet
        NODE_OPTIONS="--max-old-space-size=8192" make
        
    - name: Create deployment package
      run: |
        cd jitsi-custom/jitsi-meet
        tar -czf ../../rv2class-build.tar.gz \
          css/ images/ libs/ fonts/ sounds/ lang/ static/ \
          --exclude='*.map' \
          $(find . -maxdepth 1 -name '*.html' -o -name '*.js' | grep -v node_modules)
          
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: rv2class-build
        path: rv2class-build.tar.gz
        retention-days: 7
    
    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
        
    - name: Deploy to server via SCP
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      run: |
        sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no \
          rv2class-build.tar.gz root@$SERVER_IP:/tmp/
        
    - name: Execute deployment commands
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      run: |
        sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no \
          root@$SERVER_IP << 'DEPLOY'
          cd /usr/share/jitsi-meet
          echo "üì¶ Backing up current version..."
          tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
          
          echo "üöÄ Extracting new build..."
          tar -xzf /tmp/rv2class-build.tar.gz
          
          echo "üîí Setting permissions..."
          chown -R www-data:www-data .
          
          echo "üîÑ Clearing nginx cache..."
          rm -rf /var/cache/nginx/*
          
          echo "üîÑ Restarting nginx..."
          systemctl restart nginx
          
          echo "‚úÖ Deployment complete!"
          echo "üìä Checking deployed files..."
          ls -lh libs/app.bundle.min.js 2>/dev/null || echo "‚ö†Ô∏è Bundle file check failed"
          ls -lh css/ images/ fonts/ sounds/ | head -10
        DEPLOY
