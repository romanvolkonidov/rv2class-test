name: Build and Deploy RV2Class

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd jitsi-custom/jitsi-meet
        npm ci --legacy-peer-deps
        
    - name: Build production bundle
      run: |
        cd jitsi-custom/jitsi-meet
        NODE_OPTIONS="--max-old-space-size=8192" make
        
    - name: Create deployment package
      run: |
        cd jitsi-custom/jitsi-meet
        tar -czf ../../rv2class-build.tar.gz \
          css/ images/ libs/ fonts/ sounds/ lang/ static/ \
          *.html *.js *.css
          
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: rv2class-build
        path: rv2class-build.tar.gz
        retention-days: 7
        
    - name: Install sshpass
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y sshpass
        
    - name: Configure SSH for password auth
      run: |
        # Remove any existing SSH keys
        rm -rf ~/.ssh/id_* ~/.ssh/deploy_key* 2>/dev/null || true
        
        # Disable SSH agent
        unset SSH_AUTH_SOCK
        unset SSH_AGENT_PID
        
        # Create SSH wrapper script
        cat > /tmp/ssh-no-keys.sh << 'EOF'
#!/bin/bash
exec /usr/bin/ssh -o IdentitiesOnly=yes -o IdentityFile=/dev/null "$@"
EOF
        chmod +x /tmp/ssh-no-keys.sh
        
    - name: Deploy to server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}
        GIT_SSH_COMMAND: /tmp/ssh-no-keys.sh
      run: |
        echo "ðŸš€ Deploying to production server..."
        echo "âœ… Secrets verified. Deploying to: $SERVER_IP"
        
        # Test connection first
        echo "Testing SSH connection..."
        sshpass -e ssh -o StrictHostKeyChecking=no \
          -o IdentitiesOnly=yes \
          -o IdentityFile=/dev/null \
          -o PreferredAuthentications=password \
          -o PubkeyAuthentication=no \
          root@$SERVER_IP "echo 'âœ… SSH connection successful!'"
        
        # Upload build to server
        echo "Uploading build package..."
        sshpass -e rsync -avz --progress \
          -e "ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o IdentityFile=/dev/null -o PreferredAuthentications=password -o PubkeyAuthentication=no" \
          rv2class-build.tar.gz root@$SERVER_IP:/tmp/
        
        # Deploy on server
        echo "Deploying on server..."
        sshpass -e ssh -o StrictHostKeyChecking=no \
          -o IdentitiesOnly=yes \
          -o IdentityFile=/dev/null \
          -o PreferredAuthentications=password \
          -o PubkeyAuthentication=no \
          root@$SERVER_IP << 'DEPLOY'
        cd /usr/share/jitsi-meet
        echo "ðŸ“¦ Backing up current version..."
        tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
        
        echo "ðŸš€ Extracting new build..."
        tar -xzf /tmp/rv2class-build.tar.gz
        
        echo "ðŸ”’ Setting permissions..."
        chown -R www-data:www-data .
        
        echo "ðŸ”„ Restarting nginx..."
        systemctl restart nginx
        
        echo "âœ… Deployment complete!"
        ls -lh libs/app.bundle.min.js 2>/dev/null || echo "Bundle file check failed"
        DEPLOY
