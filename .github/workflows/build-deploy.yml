name: Build and Deploy RV2Class

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd jitsi-custom/jitsi-meet
        npm ci --legacy-peer-deps
        
    - name: Build production bundle
      run: |
        cd jitsi-custom/jitsi-meet
        NODE_OPTIONS="--max-old-space-size=8192" make
        
    - name: Create deployment package
      run: |
        cd jitsi-custom/jitsi-meet
        tar -czf ../../rv2class-build.tar.gz \
          css/ images/ libs/ fonts/ sounds/ lang/ static/ \
          *.html *.js *.css
          
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: rv2class-build
        path: rv2class-build.tar.gz
        retention-days: 7
        
    - name: Deploy to server via SSH Action
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "rv2class-build.tar.gz"
        target: "/tmp/"
        
    - name: Execute deployment commands
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /usr/share/jitsi-meet
          echo "ï¿½ Backing up current version..."
          tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
          
          echo "ðŸš€ Extracting new build..."
          tar -xzf /tmp/rv2class-build.tar.gz
          
          echo "ðŸ”’ Setting permissions..."
          chown -R www-data:www-data .
          
          echo "ðŸ”„ Restarting nginx..."
          systemctl restart nginx
          
          echo "âœ… Deployment complete!"
          ls -lh libs/app.bundle.min.js 2>/dev/null || echo "Bundle file check failed"
        
        # Upload build to server
        echo "Uploading build package..."
        sshpass -e rsync -avz --progress \
          -e "ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o IdentityFile=/dev/null -o PreferredAuthentications=password -o PubkeyAuthentication=no" \
          rv2class-build.tar.gz root@$SERVER_IP:/tmp/
        
        # Deploy on server
        echo "Deploying on server..."
        sshpass -e ssh -o StrictHostKeyChecking=no \
          -o IdentitiesOnly=yes \
          -o IdentityFile=/dev/null \
          -o PreferredAuthentications=password \
          -o PubkeyAuthentication=no \
          root@$SERVER_IP << 'DEPLOY'
        cd /usr/share/jitsi-meet
        echo "ðŸ“¦ Backing up current version..."
        tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
        
        echo "ðŸš€ Extracting new build..."
        tar -xzf /tmp/rv2class-build.tar.gz
        
        echo "ðŸ”’ Setting permissions..."
        chown -R www-data:www-data .
        
        echo "ðŸ”„ Restarting nginx..."
        systemctl restart nginx
        
        echo "âœ… Deployment complete!"
        ls -lh libs/app.bundle.min.js 2>/dev/null || echo "Bundle file check failed"
        DEPLOY
